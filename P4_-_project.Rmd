Vincent Lin
========================================================

```{r echo=FALSE, message=FALSE, warning=FALSE, packages}
# Load all of the packages that you end up using
# in your analysis in this code chunk.

# Notice that the parameter "echo" was set to FALSE for this code chunk.
# This prevents the code from displaying in the knitted HTML output.
# You should set echo=FALSE for all code chunks in your file.

library(ggplot2)
library(GGally)
library(RColorBrewer)

```

```{r echo=FALSE, Load_the_Data}
# Load the Data
pf = read.csv('data/prosperLoanData.csv', stringsAsFactors = FALSE)
```

This report explores a prosper loan data set containing 81 features and 113937 listings. The main interest is lender yield, which is the most important question to lenders: how much can I make if I invest in this loan? the other 10-15 features will be chosen based on intuition, common sense, a little experiment and the result of goggling and studying. 

After July 2009, prosper implemented a new borrower rating system, and because this is a very important features in this analysis, so all the listing before July 2009 were removed. Which leaves us 84853 listings.


```{r echo=FALSE, message=FALSE, warning=FALSE, prepare}


# remove the obvious and redundant variables
pf$ListingKey = pf$ListingNumber = pf$ClosedDate = pf$GroupKey = pf$LoanKey =
  pf$MemberKey = pf$CreditGrade = pf$LoanNumber = pf$DateCreditPulled =
  pf$FirstRecordedCreditLine = NULL

# convert to date
pf$ListingCreationDate = as.Date(
  strptime(pf$ListingCreationDate, "%Y-%m-%d %H:%M:%S"))


# convert to factor, and cap some variables to a limit
pf$IncomeRange = factor(
  pf$IncomeRange, 
  levels = c('Not employed', '$0', '$1-24,999','$25,000-49,999',
             '$50,000-74,999', '$75,000-99,999', '$100,000+'))
pf$ProsperRating..Alpha. = factor(
  pf$ProsperRating..Alpha., 
  levels = c('AA', 'A', 'B', 'C', 'D', 'E', 'HR', 'NA'))
pf$ListingCategoryF = factor(pf$ListingCategory..numeric.)
levels(pf$ListingCategoryF) = c(
  'Not Available', 'Debt Consolidation', 'Home Improvement', 'Business', 'Personal Loan', 
  'Student Use', 'Auto', 'Other', 'Baby&Adoption', 'Boat', 'Cosmetic Procedure', 
  'Engagement Ring', 'Green Loans', 'Household Expenses', 'Large Purchases', 'Medical/Dental',
  'Motorcycle', 'RV', 'Taxes', 'Vacation', 'Wedding Loans')
pf$IsBorrowerHomeowner = factor(as.logical(pf$IsBorrowerHomeowner))
pf$IncomeVerifiable = factor(as.logical(pf$IncomeVerifiable))
pf$InquiriesLast6MonthsF = factor(
  replace(pf$InquiriesLast6Months, pf$InquiriesLast6Months > 5, 6))
pf$CurrentDelinquenciesF = factor(
  replace(pf$CurrentDelinquencies, pf$CurrentDelinquencies > 4, 5))

# create a new variable and caped at 19 (99% > 19)
pf$loanToIncomeRatio = pf$LoanOriginalAmount/pf$StatedMonthlyIncome
pf$loanToIncomeRatioC = replace(
  pf$LoanOriginalAmount/pf$StatedMonthlyIncome,
  pf$LoanOriginalAmount/pf$StatedMonthlyIncome > 18, 19)


# add to numeric columns to calculate cor
pf$IncomeRangeN = as.numeric(pf$IncomeRange)
pf$IsBorrowerHomeownerN = as.numeric(pf$IsBorrowerHomeowner)
pf$IncomeVerifiableN = as.numeric(pf$IncomeVerifiable)

# choose data after July 2009
pf = pf[pf$ListingCreationDate >= '2009-07-01', ]


# choose variables to explore
pfC = data.frame(
  pf$IncomeRange, pf$ProsperRating..Alpha., pf$DebtToIncomeRatio,
  pf$IsBorrowerHomeowner, pf$InquiriesLast6Months,
  pf$TradesNeverDelinquent..percentage., pf$CreditScoreRangeLower,
  pf$ProsperScore, pf$OpenRevolvingMonthlyPayment, pf$BankcardUtilization,
  pf$LoanCurrentDaysDelinquent,pf$MonthlyLoanPayment,
  pf$LP_InterestandFees, pf$LenderYield, pf$LoanOriginalAmount)

colnames(pfC) = 
  c('IncomeRange', 'ProsperRating..Alpha.', 'DebtToIncomeRatio',
    'IsBorrowerHomeowner', 'InquiriesLast6Months',
    'TradesNeverDelinquent..percentage.', 'CreditScoreRangeLower',
    'ProsperScore', 'OpenRevolvingMonthlyPayment', 'BankcardUtilization',
    'LoanCurrentDaysDelinquent', 'MonthlyLoanPayment',
    'LP_InterestandFees', 'LenderYield', 'LoanOriginalAmount')




# a hand-picked features regression model to predict ProsperRating..numeric. (without LenderYield)
pfLM = data.frame(
  pf$IncomeRangeN, pf$ProsperRating..numeric., pf$DebtToIncomeRatio,
  pf$IsBorrowerHomeownerN, pf$InquiriesLast6Months,
  pf$TradesNeverDelinquent..percentage., pf$CreditScoreRangeLower,
  pf$ProsperScore, pf$OpenRevolvingMonthlyPayment, pf$BankcardUtilization,
  pf$LoanCurrentDaysDelinquent,pf$MonthlyLoanPayment,
  pf$LP_InterestandFees, pf$LenderYield, pf$LoanOriginalAmount)

colnames(pfLM) = 
  c('IncomeRangeN', 'ProsperRating..numeric.', 'DebtToIncomeRatio',
    'IsBorrowerHomeownerN', 'InquiriesLast6Months',
    'TradesNeverDelinquent..percentage.', 'CreditScoreRangeLower',
    'ProsperScore', 'OpenRevolvingMonthlyPayment', 'BankcardUtilization',
    'LoanCurrentDaysDelinquent', 'MonthlyLoanPayment',
    'LP_InterestandFees', 'LenderYield', 'LoanOriginalAmount')




```


# Univariate Plots Section

Summary of features that are picked to explore.

```{r echo=FALSE, message=FALSE, warning=FALSE, Summary}
dim(pfC)
str(pfC)
summary(pfC)
```

If you are a lender, then the LenderYield should be something you care the most. This number tells you how much can you make. However, if this number is accurate, higher LenderYield should represent higher risk. And judging from the histogram, there are large percentage of Prosper borrowers whose credit rating is not so great.


```{r echo=FALSE, message=FALSE, warning=FALSE, Univariate_Plots1}

# lender yield and borrower rate have extremely high correlation
ggplot(pf, aes(x = LenderYield)) + geom_histogram(binwidth = 0.01)

```

Distribution of the income range of the borrowers, 77520 out of 84853, or approximately 75%, their income is verifiable. Distribution of StatedMonthlyIncome is a typical right skewed distribution. I set the x-axis limit from 0 to 20000 because 99% of the borrowers state that their monthly income are less than 20000.

```{r echo=FALSE, message=FALSE, warning=FALSE, Univariate_Plots2}
# distribution of income range
ggplot(pf) + geom_bar(aes(x = IncomeRange))
ggplot(pf, aes(x = StatedMonthlyIncome)) + 
  geom_histogram(binwidth = 500) + 
  xlim(NA, 20000)
ecdf(pf$StatedMonthlyIncome) (20000)
table(pf$IncomeVerifiable)
```




purpose of the borrowing, roughly 63% of the borrowing is for debt consolidation.

```{r echo=FALSE, message=FALSE, warning=FALSE, Univariate_Plots3}
# purpose of borrowing
ggplot(pf, aes(x = ListingCategoryF)) + 
  geom_bar() + 
  coord_flip()
table(pf$ListingCategoryF)/dim(pf)[1]
```


Debt to income ratio, most (99%) borrowers is less than 0.72. also, there are almost 7300 NAs.

```{r echo=FALSE, message=FALSE, warning=FALSE, Univariate_Plots4}
# debt to income ratio
ggplot(pf, aes(x = DebtToIncomeRatio)) + 
  geom_histogram(binwidth = 0.01) + 
  scale_x_continuous(
    limits = c(0, quantile(pf$DebtToIncomeRatio, 0.99, na.rm = TRUE)))
quantile(pf$DebtToIncomeRatio, 0.99, na.rm = TRUE)
summary(pf$DebtToIncomeRatio)
```


Homeowner plot

```{r echo=FALSE, message=FALSE, warning=FALSE, Univariate_Plots5}
# homeowner
ggplot(pf, aes(x = IsBorrowerHomeowner)) + geom_bar()
```

Inquires last 6 months, most borrowers (99%) have less than 6 inquires. 

```{r echo=FALSE, message=FALSE, warning=FALSE, Univariate_Plots6}
ggplot(pf, aes(x = InquiriesLast6Months)) + 
  geom_bar() + 
  xlim(NA, 6.5)
quantile(pf$InquiriesLast6Months, 0.99)
summary(pf$InquiriesLast6Months)
```




Trades never delinquent, almost 42% of the borrowers never delinquent.

```{r echo=FALSE, message=FALSE, warning=FALSE, Univariate_Plots7}
ggplot(pf, aes(x = TradesNeverDelinquent..percentage.)) + 
  geom_histogram(binwidth = 0.02)
# 1 - ecdf(pf$TradesNeverDelinquent..percentage.) (0.9999)
dim(pf[pf$TradesNeverDelinquent..percentage. == 1, ])[1] / dim(pf)[1]
summary(pf$TradesNeverDelinquent..percentage.)

```

Credit score range lower and upper, for the same borrower, the difference between upper and lower is 19.

```{r echo=FALSE, message=FALSE, warning=FALSE, Univariate_Plots8}
ggplot(pf, aes(x = CreditScoreRangeLower)) + geom_bar()
table(pf$CreditScoreRangeLower, pf$CreditScoreRangeUpper)
```


bar chart of prosper score, although all the documentation says that the score range from 1 to 10, however, there are almost 1500 score 11 in the dataset.

```{r echo=FALSE, message=FALSE, warning=FALSE, Univariate_Plots9}
ggplot(pf, aes(x = ProsperScore)) + geom_bar()

```

Monthly payment on revolving accounts at the time the credit profile was pulled. 99% of the borrowers have less than 2022 open revolving monthly payment.

```{r echo=FALSE, message=FALSE, warning=FALSE, Univariate_Plots10}
ggplot(pf, aes(x = OpenRevolvingMonthlyPayment)) + 
  geom_histogram(binwidth = 100)
ggplot(pf, aes(x = OpenRevolvingMonthlyPayment)) + 
  geom_histogram(binwidth = 10) + 
  xlim(NA, 2022)
quantile(pf$OpenRevolvingMonthlyPayment, 0.99)
```


The percentage of available revolving credit that is utilized at the time the credit profile was pulled. There are almost 4000 borrowers whose percentage of available revolving credit is 0, and 622 borrowers whose percentage of available revolving credit greater than 1.

```{r echo=FALSE, message=FALSE, warning=FALSE, Univariate_Plots11}

ggplot(pf, aes(x = BankcardUtilization)) + geom_histogram(binwidth = 0.01)
by(pf$BankcardUtilization, pf$BankcardUtilization == 0, length)
by(pf$BankcardUtilization ,pf$BankcardUtilization > 1, length)

```


The number of days delinquent. There are 76445 borrowers whose days delinquent is 0. 2nd plot focus on LoanCurrentDaysDelinquent > 1.

```{r echo=FALSE, message=FALSE, warning=FALSE, Univariate_Plots12}
ggplot(pf, aes(x = LoanCurrentDaysDelinquent)) + geom_histogram()
ggplot(pf, aes(x = LoanCurrentDaysDelinquent)) + 
  geom_histogram() + 
  xlim(1, NA)
by(pf$LoanCurrentDaysDelinquent, pf$LoanCurrentDaysDelinquent == 0, length)

```

The distribution of monthly loan payment, there is one thing I feel interesting, there are 91 borrowers, who make less monthly income than monthly loan payment, and their income is verifiable. 68 out of these 91 borrowers are not even a homeowner.

```{r echo=FALSE, message=FALSE, warning=FALSE, Univariate_Plots13}
ggplot(pf, aes(x = MonthlyLoanPayment)) + geom_histogram()

length(
  pf$MonthlyLoanPayment[(pf$StatedMonthlyIncome < pf$MonthlyLoanPayment) &
                          pf$IncomeVerifiable == TRUE])

length(
  pf$MonthlyLoanPayment[(pf$StatedMonthlyIncome < pf$MonthlyLoanPayment) &
                          pf$IncomeVerifiable == TRUE & 
                          pf$IsBorrowerHomeowner == FALSE])

```

I create a new variable called loanToIncomeRatio = LoanOriginalAmount/StatedMonthlyIncome, then I cap it at 19 because 99% of the loanToIncomeRatio are less or equal to 18 and call this new variable loanToIncomeRatioC. Almost 84% of the borrowers borrow loans amount less than 3 months of income. 

```{r echo=FALSE, message=FALSE, warning=FALSE, Univariate_Plots14}
ggplot(pf, aes(x = loanToIncomeRatioC)) + geom_density()
ggplot(pf, aes(x = loanToIncomeRatioC)) + 
  geom_density() + 
  xlim(NA, 7)
quantile(pf$loanToIncomeRatio, 0.99)
ecdf(pf$loanToIncomeRatio) (3)

```

bar chart of ProsperRating..Alpha. 

```{r echo=FALSE, message=FALSE, warning=FALSE, Univariate_Plots15}
ggplot(pf, aes(x = ProsperRating..Alpha.)) + geom_bar()
```




# Univariate Analysis

### What is the structure of your dataset?

The original dataset has 113917 listing and 81 features, however, after July 2009, prosper implemented new rating system, therefore, I only use data after July 2009, which is about 75% of the original dataset.

### What is/are the main feature(s) of interest in your dataset?

The main feature is LenderYield, I'd like to find out which features are best for predicting lender yield.

### What other features in the dataset do you think will help support your investigation into your feature(s) of interest?

Income, property owner, current debt, records of default, purpose of borrowing, credit rating.

### Did you create any new variables from existing variables in the dataset?

I create a new variable called loanToIncomeRatio = LoanOriginalAmount/StatedMonthlyIncome, then I cap it at 19 and call it loanToIncomeRatioC, because 99% of the loanToIncomeRatio are less or equal to 18.
And I cap CurrentDelinquencies and InquiriesLast6Months and call them CurrentDelinquenciesF and InquiriesLast6MonthsF for plotting purpose.

### Of the features you investigated, were there any unusual distributions? Did you perform any operations on the data to tidy, adjust, or change the form of the data? If so, why did you do this?

BankcardUtilization, this m-shape histogram reminds me disappearing middle class. In the plot, many people either has no money can borrow or already maxed out their credit.



# Bivariate Plots Section


```{r echo=FALSE, message=FALSE, warning=FALSE, correlations}
cor(pfLM, use = 'pairwise.complete.obs')


```

Common sense tells us that if borrowing rate is high, then lender yield is high, therefore, they should have high correlation. And we can also deduce from summary(pf$BorrowerRate - pf$LenderYield) that prosper take 1% of the loans as a fee (40 listing are 2%).

```{r echo=FALSE, message=FALSE, warning=FALSE, Bivariate_Plots1}
ggpairs(pf, columns = c('BorrowerAPR', 'BorrowerRate', 'LenderYield'))
summary(pf$BorrowerRate - pf$LenderYield)

```


Higher income, lower lender yield. red x represents mean.

```{r echo=FALSE, message=FALSE, warning=FALSE, Bivariate_Plots2}
ggplot(pf, aes(x = IncomeRange, y = LenderYield)) + 
  geom_boxplot() + 
  stat_summary(fun.y = mean, color = 'red', geom = 'point', 
               size = 2, shape = 4)

```

LenderYield against DebtToIncomeRatio, 2nd plot focus on 99% of the DebtToIncomeRatio (0 to 0.72). Blue dotted line are 10% or 90% percentile, blue solid line is median, red line is mean. This is a very intuitive plot, most people wouldn't consider lending money to a person who have mountain high of debt unless there are enough risk premium. Though this is a very noisy plot, it imples that they might only have very weakly correlation

```{r echo=FALSE, message=FALSE, warning=FALSE, Bivariate_Plots3}
ggplot(pf, aes(x = DebtToIncomeRatio, y = LenderYield)) + 
  geom_point(alpha = 1/10)
ggplot(pf, aes(x = DebtToIncomeRatio, y = LenderYield)) + 
  geom_point(alpha = 1/10, color = 'orange') + 
  xlim(NA, 0.72)+ 
  geom_line(stat = 'summary', fun.y = mean, color = 'red', size = 2) + 
  geom_line(stat = 'summary', fun.y = quantile, 
            fun.args = list(probs = .1), linetype = 2, color = 'blue') + 
  geom_line(stat = 'summary', fun.y = quantile, 
            fun.args = list(probs = .5), color = 'blue') + 
  geom_line(stat = 'summary', fun.y = quantile, 
            fun.args = list(probs = .9), linetype = 2, color = 'blue')

cor.test(pf$LenderYield, pf$DebtToIncomeRatio, alternative = 'greater')

```

Most home owner can get slightly lower interest rate, another word, for lenders, its risk is lower. 2nd plot shows that they are not normally distributed, so I perform Mann-Whitney-Wilcoxon test to further support the theory.

```{r echo=FALSE, message=FALSE, warning=FALSE, Bivariate_Plots4}
ggplot(pf, aes(x = IsBorrowerHomeowner, y = LenderYield)) + 
  geom_boxplot() + 
  stat_summary(fun.y = mean, color = 'red', geom = 'point', 
               size = 2, shape = 4)

ggplot(pf, aes(x = LenderYield, color = IsBorrowerHomeowner)) + geom_density()

wilcox.test(LenderYield ~ IsBorrowerHomeowner, data = pf)
```

I cap the top 1% of InquiriesLast6Months at 6 and call it InquiriesLast6MonthsF, then draw a box plot, it's clear that less inquiries, less lender yield (less risk).

```{r echo=FALSE, message=FALSE, warning=FALSE, Bivariate_Plots5}

ggplot(pf, aes(x = InquiriesLast6MonthsF, y = LenderYield)) + 
  geom_boxplot() + 
  stat_summary(fun.y = mean, color = 'red', geom = 'point', 
               size = 2, shape = 4)

```

This graph shows a trend that borrowers who have utilized more available revolving credit getting higher interest rate (except for 3945 borrowers who have 0 available revolving credit). 664 of 3945 borrowers who have 0 open revolving account, therefore, their average lender yield is higher.

```{r echo=FALSE, message=FALSE, warning=FALSE, Bivariate_Plots6}


ggplot(pf, aes(x = BankcardUtilization, y = LenderYield)) + 
  geom_point(position = 'jitter', alpha = 1/20, color = 'orange') + 
  xlim(NA, 1.01) +  
  geom_line(stat = 'summary', fun.y = mean, color = 'red', size = 2) + 
  geom_line(stat = 'summary', fun.y = quantile, 
            fun.args = list(probs = .1), linetype = 2, color = 'blue') + 
  geom_line(stat = 'summary', fun.y = quantile, 
            fun.args = list(probs = .5), color = 'blue') + 
  geom_line(stat = 'summary', fun.y = quantile, 
            fun.args = list(probs = .9), linetype = 2, color = 'blue')

cor.test(pf$LenderYield, pf$BankcardUtilization, alternative = 'greater')


by(pf$BankcardUtilization, pf$BankcardUtilization == 0, length)
by(pf$BankcardUtilization, 
   pf$BankcardUtilization == 0 & pf$OpenRevolvingAccounts == 0, length)
by(pf$LenderYield, pf$OpenRevolvingAccounts == 0, summary)

```




```{r echo=FALSE, message=FALSE, warning=FALSE, Bivariate_Plots7}


ggplot(pf, aes(x = TradesNeverDelinquent..percentage., y = LenderYield)) + 
  geom_point(position = 'jitter', alpha = 1/20, color = 'orange') + 
  xlim(0.24, 1.01) +  
  geom_line(stat = 'summary', fun.y = mean, color = 'red', size = 2) + 
  geom_line(stat = 'summary', fun.y = quantile, 
            fun.args = list(probs = .1), linetype = 2, color = 'blue') + 
  geom_line(stat = 'summary', fun.y = quantile, 
            fun.args = list(probs = .5), color = 'blue') + 
  geom_line(stat = 'summary', fun.y = quantile, 
            fun.args = list(probs = .9), linetype = 2, color = 'blue')

```






```{r echo=FALSE, message=FALSE, warning=FALSE, Bivariate_Plots8}

ggplot(pf, aes(x = CreditScoreRangeLower, y = LenderYield)) + 
  geom_point(alpha = 1/20, position = 'jitter', color = 'orange') + 
  geom_line(stat = 'summary', fun.y = mean, color = 'red', size = 2) + 
  geom_line(stat = 'summary', fun.y = quantile, 
            fun.args = list(probs = .1), linetype = 2, color = 'blue') + 
  geom_line(stat = 'summary', fun.y = quantile, 
            fun.args = list(probs = .5), color = 'blue') + 
  geom_line(stat = 'summary', fun.y = quantile, 
            fun.args = list(probs = .9), linetype = 2, color = 'blue')

```



```{r echo=FALSE, message=FALSE, warning=FALSE, Bivariate_Plots9}

ggplot(pf, aes(x = ProsperScore, LenderYield)) + 
  geom_point(alpha = 1/20, position = 'jitter', color = 'orange') + 
  geom_line(stat = 'summary', fun.y = mean, color = 'red', size = 2) + 
  geom_line(stat = 'summary', fun.y = quantile, 
            fun.args = list(probs = .1), linetype = 2, color = 'blue') + 
  geom_line(stat = 'summary', fun.y = quantile, 
            fun.args = list(probs = .5), color = 'blue') + 
  geom_line(stat = 'summary', fun.y = quantile, 
            fun.args = list(probs = .9), linetype = 2, color = 'blue')
```



LenderYield against MonthlyLoanPayment is a very interesting plot, so many straight lines mean some other variables affecting MonthlyLoanPayment. 

2nd plot implies that MonthlyLoanPayment are spread loosely, that's why the mean and other percentile line are so fluctuated because there are maybe only 1 to 10 (x, y) pairs on one x. One variable comes to mind is LoanOriginalAmount because it has high correlation with MonthlyLoanPayment. 

So the 3rd plot proves my intuitive, however, there must be another variables affecting both of them, my guess is Term, since there are only 3 terms on prosper loans, and the plot also has 3 'lines'.

The 4th plot shows higher the LoanOriginalAmount, lower the LenderYield, it should be because only borrowers have higher rating get to borrow higher amount, and borrowers have higher rating can enjoy lower interest.

One thing strange do occur to me when I look at 3rd plot, there are 484 borrowers whose MonthlyLoanPayment == 0.

```{r echo=FALSE, message=FALSE, warning=FALSE, Bivariate_Plots10}

ggplot(pf, aes(x = MonthlyLoanPayment, y = LenderYield)) + 
  geom_point(alpha = 1/20) + 
  xlim(NA, quantile(pf$MonthlyLoanPayment, c(0.99)))

ggplot(pf, aes(x = MonthlyLoanPayment, y = LenderYield)) + 
  geom_point(alpha = 1/20, color = 'orange') + 
  xlim(NA, quantile(pf$MonthlyLoanPayment, c(0.99))) + 
  stat_summary_bin(geom = 'line', fun.y = mean, color = 'red', size = 2) + 
  stat_summary_bin(geom = 'line', fun.y = quantile, 
                   fun.args = list(probs = .1), linetype = 2, color = 'blue') +
  stat_summary_bin(geom = 'line', fun.y = quantile, 
                   fun.args = list(probs = .5), color = 'blue') + 
  stat_summary_bin(geom = 'line', fun.y = quantile, 
                   fun.args = list(probs = .9), linetype = 2, color = 'blue')

ggplot(pf, aes(x = LoanOriginalAmount, y = MonthlyLoanPayment)) + 
  geom_point(alpha = 1/20) + 
  ylim(NA, quantile(pf$MonthlyLoanPayment, c(0.99))) 



ggplot(pf, aes(x = LoanOriginalAmount, y = LenderYield)) +  
  geom_point(alpha = 1/20, position = 'jitter', color = 'orange') + 
  stat_summary_bin(geom = 'line', fun.y = mean, color = 'red', size = 2) + 
  stat_summary_bin(geom = 'line', fun.y = quantile, 
                   fun.args = list(probs = .1), linetype = 2, color = 'blue') +
  stat_summary_bin(geom = 'line', fun.y = quantile, 
                   fun.args = list(probs = .5), color = 'blue') + 
  stat_summary_bin(geom = 'line', fun.y = quantile, 
                   fun.args = list(probs = .9), linetype = 2, color = 'blue')

by(pf$LoanOriginalAmount, pf$ProsperRating..Alpha., summary)


by(pf$MonthlyLoanPayment, pf$MonthlyLoanPayment == 0, length)



```

looks like we have found the most important factors deciding lender yield, even with some outliers, the mean still wasn't affected in all rating categories.

```{r echo=FALSE, message=FALSE, warning=FALSE, Bivariate_Plots11}

ggplot(pf, aes(x = ProsperRating..Alpha., y = LenderYield)) + 
  geom_boxplot() + 
  stat_summary(fun.y = mean, color = 'red', geom = 'point', 
               size = 2, shape = 4)

```





# Bivariate Analysis

### Talk about some of the relationships you observed in this part of the investigation. How did the feature(s) of interest vary with other features in the dataset?

LenderYield strongly correlates with ProsperRating..Alpha., in fact, using linear regression, ProsperRating..Alpha. one variable alone can explain about 91% of the variance of the LenderYield. No other variable can provide such high r-squared. 

For many cases, we can all observe a trend, you have a house, less inquiries, high income, lower debtToIncomeRatio, less BankcardUtilization, better credit score can help borrower get a lower interest, especially credit score.

LenderYield against MonthlyLoanPayment is the most interesting plot I have seen so far. This plot looks like somebody randomly draw some line on it. 


### Did you observe any interesting relationships between the other features (not the main feature(s) of interest)?

MonthlyLoanPayment and LoanOriginalAmount, they are highly positively correlated with each other, however, there are 3 lines of them instead of one line in most highly correlated cases.


### What was the strongest relationship you found?

ProsperRating and LenderYield, their correlation is about -0.95. Basically, if a borrower have higher ProsperRating, he can get a lower borrowing interest.


# Multivariate Plots Section

This density plot reaffirms the boxplot of LenderYield by IncomeRange, borrowers who have higher income can get better interest rate. Although their range still remain the same from 0 to 0.34, the mode shifts.

```{r echo=FALSE,message=FALSE, warning=FALSE,  Multivariate_Plots1}
ggplot(pf, aes(x = LenderYield, color = IncomeRange)) + 
  geom_density() + scale_color_brewer(type = 'seq', palette = 2) + 
  theme_dark()
by(pf$LenderYield, pf$IncomeRange, summary)


```

```{r echo=FALSE,message=FALSE, warning=FALSE,  Multivariate_Plots2}
ggplot(pf, aes(x = LenderYield, color = InquiriesLast6MonthsF)) +
  geom_density() + 
  scale_color_brewer(type = 'seq', palette = 2) + 
  theme_dark()
by(pf$LenderYield, pf$InquiriesLast6MonthsF, summary)


```

From the density plot facet wrap by ProsperRating, we can observe that most of them are not overlapping with each other. The worst rating put most weight around 0.3.


```{r echo=FALSE,message=FALSE, warning=FALSE,  Multivariate_Plots3}

ggplot(pf, aes(x = LenderYield, color = ProsperRating..Alpha.)) + 
  geom_density() + 
  scale_color_brewer(type = 'seq', palette = 2) + 
  theme_dark()
by(pf$LenderYield, pf$ProsperRating..Alpha., summary)


ggplot(pf, aes(x = LenderYield)) + 
  geom_density() + 
  scale_color_brewer(type = 'seq', palette = 2) + 
  facet_wrap(~ ProsperRating..Alpha.) +
  ggtitle(label = 'Facet wrap by Prosper rating') + 
  theme(plot.title=element_text(hjust=0.5))

ggplot(pf, aes(x = LenderYield)) + 
  geom_density() + 
  scale_color_brewer(type = 'seq', palette = 2) + 
  facet_wrap(~ ProsperRating..Alpha.) + 
  ylim(NA, 50) + 
  ggtitle(label = 'Facet wrap by Prosper rating limit y-axis') + 
  theme(plot.title=element_text(hjust=0.5))

ggplot(pf[pf$ProsperRating..Alpha. == 'HR',], aes(x = LenderYield)) + 
  geom_density() + 
  xlim(0.29, 0.32) + 
  ggtitle('density of lender yield of prosper rating == HR') + 
  theme(plot.title=element_text(hjust=0.5))



```

This plot explains why there are so many straight lines in plot of LenderYield against MonthlyLoanPayment. Because under the same loan amount, when LenderYield (borrower interest rate) increases, MonthlyLoanPayment also increase linearly. Loan amount and interest rate decides monthly payment.


```{r echo=FALSE, message=FALSE, warning=FALSE, Multivariate_Plots4}

ggplot(pf, aes(x = LoanOriginalAmount, y = MonthlyLoanPayment, 
               color = LenderYield)) + 
  geom_point(alpha = 1/20) + 
  ylim(NA, quantile(pf$MonthlyLoanPayment, c(0.99))) + 
  facet_wrap(~ Term) + 
  ggtitle('Facet wrap by Term')

ggplot(pf, aes(x = MonthlyLoanPayment, y = LenderYield, 
               color = LoanOriginalAmount)) + 
  geom_point() + 
  xlim(250, quantile(pf$MonthlyLoanPayment, c(0.99))) + 
  scale_color_gradient2(low = "red", mid = "white", 
                        high = "darkgreen", midpoint = 15000) +
  theme_dark()



```

ProsperScore has the 2nd highest correlation with LenderYield (-0.65), however, from this plot, we can see that its predicting power is nothing comparing to ProsperRating. Even though with a lower ProsperScore as 3, its lenderYield still ranges from 0.1 to 0.34.

```{r echo=FALSE, message=FALSE, warning=FALSE, Multivariate_Plots5}

ggplot(pf, aes(x = ProsperScore, y = LenderYield, 
               color = ProsperRating..Alpha.)) + 
  geom_point(position = 'jitter') + 
  scale_color_brewer(type = 'seq') + 
  theme_dark() 
by(pf$LenderYield, pf$ProsperScore, summary)


```






```{r echo=FALSE, message=FALSE, warning=FALSE, Linear_Regression}

summary(lm(LenderYield ~ ProsperRating..Alpha., data = pf))

summary(lm(ProsperRating..numeric. ~. -LenderYield, data = pfLM))


pfLM1 = pf

pfLM1$ListingCreationDate = pfLM1$LoanStatus = pfLM1$BorrowerAPR =
  pfLM1$BorrowerRate = pfLM1$BorrowerState = pfLM1$IsBorrowerHomeownerN =
  pfLM1$EstimatedEffectiveYield = pfLM1$EstimatedLoss = pfLM1$EstimatedReturn =
  pfLM1$Occupation = pfLM1$EmploymentStatus = pfLM1$CurrentlyInGroup =
  pfLM1$LoanOriginationDate = pfLM1$LoanOriginationQuarter =
  pfLM1$InquiriesLast6MonthsF = pfLM1$CurrentDelinquenciesF =
  pfLM1$IncomeVerifiableN = pfLM1$IncomeRangeN = pfLM1$ProsperRating..Alpha. =
  pf$ListingCategoryF = NULL


pfLM1$TotalProsperLoans = pfLM1$TotalProsperPaymentsBilled =
  pfLM1$OnTimeProsperPayments = pfLM1$ProsperPaymentsLessThanOneMonthLate =
  pfLM1$ProsperPaymentsOneMonthPlusLate = pfLM1$ProsperPrincipalBorrowed =
  pfLM1$ProsperPrincipalOutstanding = pfLM1$ScorexChangeAtTimeOfListing =
  pfLM1$LoanFirstDefaultedCycleNumber = NULL

pfLM1.na = na.omit(pfLM1)

modStep = step(lm(ProsperRating..numeric. ~. -LenderYield, data = pfLM1.na))

summary(modStep)
```

# Multivariate Analysis

### Talk about some of the relationships you observed in this part of the investigation. Were there features that strengthened each other in terms of looking at your feature(s) of interest?

From the density plot, we can observe different level of many variables will shift the mode a little bit, but overall, their range still overlap except ProsperRating. The lenderYield density plot facet wrap by ProsperRating shows a most non-overlapping plot.

### Were there any interesting or surprising interactions between features?

Yes, LenderYield by MonthlyLoanPayment and LoanOriginalAmount, at first glance, I know that it must has third variable interact with them, and this variable should have linear relationship with one of them. However, it did take me a while to find out what the variable is.


### OPTIONAL: Did you create any models with your dataset? Discuss the strengths and limitations of your model.

Yes, I created 3 models, first one is just using formula = LenderYield ~ ProsperRating..Alpha., and its r-squared is 0.9138. A little digging up told me that the borrower rates are actually decided by the ProsperRating. So my interest turns to predict ProsperRating using other variables (of course not including LenderYield and other highly correlated variables), I hand-picked 13 variables to fit a linear model against ProsperRating, and I got 0.6918 r-squared. Lastly, I removed some variable then use step() function to find out a linear model using 34 independent variables to predict ProsperRating, which has 0.74 r-squared.

------

# Final Plots and Summary

### Plot One
```{r echo=FALSE, message=FALSE, warning=FALSE, Plot_One}
ggplot(pf, aes(x = BankcardUtilization)) + 
  geom_histogram(binwidth = 0.01) + 
  scale_x_continuous(breaks = seq(0, 1, 0.2), limits = c(NA, 1.1)) +
  ggtitle(label = 'Histogram of Bank card Utilization') + 
  xlab('Bank card utilization (in ratio)') + 
  ylab('Number of Borrowers') +
  theme(plot.title=element_text(hjust=0.5))

```

### Description One

This m-shaped distribution represents many infamous phenomenon during these era, such as disappearing middle class, poor become poorer, rich become richer. However, in this plot, either end doesn't mean a good thing, because you either don't qualify to get a credit (thus 0 BankcardUtilization), or you already maxed out your credit.


### Plot Two
```{r  echo=FALSE, message=FALSE, warning=FALSE, Plot_Two}
ggplot(pf, aes(x = ProsperRating..Alpha., y = LenderYield)) + 
  geom_boxplot() + 
  stat_summary(fun.y = mean, color = 'red', geom = 'point', 
               size = 2, shape = 4) + 
  ggtitle(label = 'Lender yield by Prosper rating') + 
  xlab('Prosper rating (in category)') + 
  ylab('Lender yield (in rate)') + 
  theme(plot.title=element_text(hjust=0.5))


```

### Description Two

ProsperRating is the most important variable affecting LenderYield, the IQR of each lender yield of different categories are never overlap, and even with some outliers, the mean lender yield of each category still close to its median. So for most of the time, a borrower at better category (like AA) will get a better (lower) interest rate than those at inferior category (like A). Two numbers can further support the plot, their correlation is about -0.95, and if we run a linear regression model using formula = LenderYield ~ ProsperRating, we can get about 0.91 of r-square. 

### Plot Three
```{r echo=FALSE, message=FALSE, warning=FALSE, Plot_Three}


ggplot(pf, aes(x = MonthlyLoanPayment, y = LenderYield, 
               color = LoanOriginalAmount)) + 
  geom_point() + 
  xlim(NA, quantile(pf$MonthlyLoanPayment, c(0.99))) + 
  scale_color_gradient2(low = "red", mid = "white",
                        high = "darkgreen", midpoint = 10000) +
  theme_dark() + 
  theme(legend.position="bottom", legend.text = element_text(size = 7)) + 
  ggtitle(label = 'Lender yield by monthly loan payment and loan original amount') + 
  theme(plot.title=element_text(hjust=0.5)) + 
  labs(color = 'loan original amount') + 
  xlab('Monthly loan payment (in dollar)') + 
  ylab('Lender yield (in rate)')


```

### Description Three

If we look at the math formula of how to calculate interest rate, under the same loan amount and the same term, higher interest rate gets higher monthly payment, you would think that monthly payment should have positive correlation with interest rate (LenderYield). However, if we look at the big picture, the LenderYield actually has negative correlation with MonthlyLoanPayment (-0.33). In this case, higher ProsperRating gets lower interest rate and higher MonthlyLoanPayment, that's why LenderYield is negatively correlated with MonthlyLoanPayment.




------

# Reflection

Prosper loan dataset is a big dataset, 81 features, each represents something you might or might not ignore, depends on what you try to understand. Initially, I want to figure out what features affecting lender yield, because I think this is an important number investor want to know, this number should include everything such as risk premium. The process of investigation spent more time than I was expected. One of the reasons is that I tried to build a linear regression model using fewer features to achieve higher r-squared. Some variables seem important intuitively, however, once included in the linear regression model, it only improves r-squared by 0.012 (Listing Category).  So I spend most times reading and thinking, it's rewarding though, not only have I gained the knowledge of how Prosper functioning, but also I have learned a lot about how to rate one person's credit.

During the process of investigation on the dataset and prosper website, I figured out the interest rate is decided by Prosper rating. Most borrowers in the same rating will get a narrow range of interest rate which does not overlap with other ratings.

After finding out the fact, my question soon to become: what features deciding Prosper rating? Prosper doesn't reveal how they calculate the rating for borrowers; it'll be fascinating if we can approximate the result using the data on hand. I think that this is the fun part of data analyze, you try to discover the insight from the data, predict one of the features.

And through the process, I also learned some of the facts like most borrowers only borrow money that less than three times of their monthly income. I think this is another business insight worth to figure out: the reason people come to Prosper. Combined with the fact that 63% of the purpose of the borrowing is debt consolidation, and the interest rate of Prosper is slightly lower than credit card rate. I can think of one reason that people come to Prosper is to get a lower interest rate for their credit card debt. This may provide some room for arbitrage if we know our audiences well.

